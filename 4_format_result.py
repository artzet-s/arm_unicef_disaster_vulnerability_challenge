import pandas
import numpy as np
import json


def load_json(path):
    with open(path, "r") as f:
        return json.load(f)


def process_codetr(gt_json_path, pred_json_path, output_csv_path, score=0.5):

    gt_test_data = load_json(gt_json_path)
    pred_test_data = load_json(pred_json_path)

    df_pred = pandas.DataFrame(pred_test_data)
    df_pred = df_pred[df_pred["score"] >= score]
    rows = list()
    for img_info in gt_test_data["images"]:

        nb_1 = 0
        nb_2 = 0
        nb_3 = 0

        cond = df_pred["image_id"] == img_info["id"]
        if np.any(cond):
            df_img = df_pred[cond]

            nb_1 = np.count_nonzero(df_img["category_id"] == 0)
            nb_2 = np.count_nonzero(df_img["category_id"] == 1)
            nb_3 = np.count_nonzero(df_img["category_id"] == 2)

        image_id = (
            img_info["file_name"].replace(f"{ img_info['id']}_", "").replace(".jpg", "")
        )

        rows.append({"image_id": f"{image_id}_1", "Target": nb_1})
        rows.append({"image_id": f"{image_id}_2", "Target": nb_2})
        rows.append({"image_id": f"{image_id}_3", "Target": nb_3})

    df = pandas.DataFrame(rows)
    df.to_csv(output_csv_path, index=False)


if __name__ == "__main__":

    gt_json_path = "./data/coco/test/annotation_coco.json"

    # pred_json_path = "./work_dirs/my_codetr/test.bbox.json"
    # output_csv_path = "./data/final_pred_test_codetr_2_1024_ct045.csv"
    # process_codetr(gt_json_path, pred_json_path, output_csv_path, score=0.45)

    pred_json_path = "./work_dirs/my_codetr/test.bbox.json"
    output_csv_path = "./data/final_pred_test_codetr_2_960_ct045.csv"
    process_codetr(gt_json_path, pred_json_path, output_csv_path, score=0.45)
